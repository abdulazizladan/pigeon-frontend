<h1>Support tickets</h1>
<div class="users-list-container">
  @if(authStore.userRole() != 'admin'){
  <div class="header" fxLayout="row">
    <span fxFlex="1 1 auto"></span>
    <button mat-flat-button color="primary" (click)="openAddTicketDialog()">
      <mat-icon>add</mat-icon>
      Add new ticket
    </button>
  </div>
  } @else {
  <div class="stats-container">
    <mat-card class="stat-card total">
      <mat-card-header>
        <mat-card-title>{{ticketsStore.stats().total}}</mat-card-title>
        <mat-card-subtitle>Total Tickets</mat-card-subtitle>
      </mat-card-header>
    </mat-card>
    <mat-card class="stat-card active">
      <mat-card-header>
        <mat-card-title>{{ticketsStore.stats().active}}</mat-card-title>
        <mat-card-subtitle>Active</mat-card-subtitle>
      </mat-card-header>
    </mat-card>
    <mat-card class="stat-card resolved">
      <mat-card-header>
        <mat-card-title>{{ticketsStore.stats().resolved}}</mat-card-title>
        <mat-card-subtitle>Resolved</mat-card-subtitle>
      </mat-card-header>
    </mat-card>
    <mat-card class="stat-card terminated">
      <mat-card-header>
        <mat-card-title>{{ticketsStore.stats().dismissed}}</mat-card-title>
        <mat-card-subtitle>Terminated</mat-card-subtitle>
      </mat-card-header>
    </mat-card>
  </div>

  <div class="filter-container">
    <mat-form-field appearance="outline">
      <mat-label>Filter by Status</mat-label>
      <mat-select (selectionChange)="applyFilter($event.value)" value="all">
        <mat-option value="all">All</mat-option>
        <mat-option value="active">Active</mat-option>
        <mat-option value="resolved">Resolved</mat-option>
        <mat-option value="terminated">Terminated</mat-option>
      </mat-select>
    </mat-form-field>
  </div>
  }

  @if(ticketsStore.loading()){
  <mat-progress-bar mode="query"></mat-progress-bar>
  }

  @if(ticketsStore.error()) {
  <mat-error>{{ticketsStore.error()}}</mat-error>
  }

  <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef>Title</th>
      <td mat-cell *matCellDef="let ticket">
        {{ticket.title}}
      </td>
    </ng-container>

    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef>Description</th>
      <td mat-cell *matCellDef="let ticket">
        {{ticket.description}}
      </td>
    </ng-container>

    <ng-container matColumnDef="sender">
      <th mat-header-cell *matHeaderCellDef>Sender</th>
      <td mat-cell *matCellDef="let ticket">
        {{ticket.sender?.email}}
      </td>
    </ng-container>

    <ng-container matColumnDef="dateCreated">
      <th mat-header-cell *matHeaderCellDef>Date created</th>
      <td mat-cell *matCellDef="let ticket">
        {{ticket.dateCreated | date:'shortDate'}}
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let ticket">
        @if(authStore.userRole() === 'admin'){
        <mat-form-field appearance="outline" class="status-dropdown" (click)="$event.stopPropagation()">
          <mat-select [value]="ticket.status" (selectionChange)="onStatusChange(ticket, $event.value)">
            <mat-option value="active">Active</mat-option>
            <mat-option value="resolved">Resolved</mat-option>
            <mat-option value="terminated">Terminated</mat-option>
          </mat-select>
        </mat-form-field>
        } @else {
        @if(ticket.status === 'active'){
        <span class="status-active">active</span>
        }
        @if(ticket.status == 'resolved'){
        <span class="status-resolved">resolved</span>
        }
        @if(ticket.status == 'terminated'){
        <span class="status-terminated">terminated</span>
        }
        }
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;" [routerLink]="row.id ? [row.id] : null"
      [class.clickable-row]="row.id">
    </tr>
  </table>
  <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"
    aria-label="Select page of tickets"></mat-paginator>
</div>